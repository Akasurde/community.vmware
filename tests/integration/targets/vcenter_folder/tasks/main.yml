# Test code for the vcenter_folder module.
# Copyright: (c) 2018, Abhijeet Kasurde <akasurde@redhat.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Create all types of folder in check mode
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: "{{ item }}_folder"
    folder_type: "{{ item }}"
    state: present
  register: all_folder_results
  with_items:
    - vm
    - host
    - datastore
    - network
  check_mode: yes

- debug:
    msg: "{{ all_folder_results }}"

- name: ensure everything for {{ dc1 }}
  assert:
    that:
        - all_folder_results.changed

- name: Create all types of folder
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: "{{ item }}_folder"
    folder_type: "{{ item }}"
    state: present
  register: all_folder_results
  with_items:
    - vm
    - host
    - datastore
    - network

- debug:
    msg: "{{ all_folder_results }}"

- name: ensure everything for {{ dc1 }}
  assert:
    that:
        - all_folder_results.changed

- name: Create all types of sub folder in check mode
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: "sub_{{ item }}_folder"
    parent_folder: 'vm_folder'
    state: present
  register: all_folder_results
  with_items:
    - vm
    - host
    - datastore
    - network
  check_mode: yes

- debug:
    msg: "{{ all_folder_results }}"

- name: ensure everything for {{ dc1 }}
  assert:
    that:
        - all_folder_results.changed

- name: Create all types of sub folder
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: "sub_{{ item }}_folder"
    parent_folder: 'vm_folder'
    state: present
  register: all_folder_results
  with_items:
    - vm
    - host
    - datastore
    - network

- name: Recreate all types of sub folder
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: "sub_{{ item }}_folder"
    parent_folder: 'vm_folder'
    state: present
  register: recreate_folders
  with_items:
    - vm
    - host
    - datastore
    - network

- name: Create a 3rd level of directory
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: yet_another_level
    parent_folder: vm_folder/sub_vm_folder
    state: present
  register: yet_another_level
- debug: var=yet_another_level

- name: Recreate a 3rd level of directory
  vcenter_folder:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: yet_another_level
    parent_folder: vm_folder/sub_vm_folder
    state: present
  register: recreate_yet_another_level
- debug: var=recreate_yet_another_level

- debug:
    msg: "{{ all_folder_results }}"

- name: ensure everything for {{ dc1 }}
  assert:
    that:
        - all_folder_results.changed
        - not recreate_folders.changed
        - not recreate_yet_another_level.changed

# MOID test
- name: Create tier1 folder
  vcenter_folder:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: tier1
    folder_type: vm
    state: present

- name: Create tier2 folder under tier1 folder
  vcenter_folder:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: tier2
    parent_folder: tier1
    folder_type: vm
    state: present

- name: Gather folder information
  vmware_folder_info:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    validate_certs: no
    datacenter: "{{ dc1 }}"
  register: folder_info

- name: Get folder moid for tier1/tier2
  set_fact:
    parent_folder_moid: "{{ (folder_info['flat_folder_info'] | selectattr('path', 'search', '/vm/tier1/tier2') | map(attribute='moid'))[0] }}"

- name: Create tier3 folder under tier1/tier2 folder using moid
  vcenter_folder:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    validate_certs: no
    datacenter: "{{ dc1 }}"
    folder_name: tier3
    parent_folder_moid: '{{ parent_folder_moid }}'
    folder_type: vm
    state: present

## Testcase: Delete all types of folder
#
# Doesn't work with vcsim. Looks like UnregisterAndDestroy isn't supported.
- when: vcsim is not defined
  block:
  - name: Remove a 3rd level of directory
    vcenter_folder:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      datacenter: "{{ dc1 }}"
      folder_name: yet_another_level
      parent_folder: vm_folder/sub_vm_folder
      state: absent
    register: remove_yet_another_level
  - debug: var=remove_yet_another_level

  - name: Delete all types of folder
    vcenter_folder:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      datacenter: "{{ dc1 }}"
      folder_name: "{{ item }}_folder"
      folder_type: "{{ item }}"
      state: absent
    register: all_folder_results
    with_items:
      - vm
      - host
      - datastore
      - network

  - debug: msg="{{ all_folder_results }}"

  - name: ensure everything for {{ dc1 }}
    assert:
      that:
          - all_folder_results.changed

  - name: Delete all types of folder again
    vcenter_folder:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      datacenter: "{{ dc1 }}"
      folder_name: "{{ item }}_folder"
      folder_type: "{{ item }}"
      state: absent
    register: all_folder_results
    with_items:
      - vm
      - host
      - datastore
      - network

  - debug: msg="{{ all_folder_results }}"

  - name: ensure everything for {{ dc1 }}
    assert:
      that:
          - not all_folder_results.changed

  - name: Delete tier3 folder
    vcenter_folder:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: no
      datacenter: '{{ dc1 }}'
      folder_name: tier3
      parent_folder_moid: '{{ parent_folder_moid }}'
      state: absent
    register: delete_tier3

  - name: Delete tier2 folder
    vcenter_folder:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: no
      datacenter: '{{ dc1 }}'
      folder_name: tier2
      parent_folder: tier1
      state: absent
    register: delete_tier2

  - name: Delete tier1 folder
    vcenter_folder:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: no
      datacenter: '{{ dc1 }}'
      folder_name: tier1
      state: absent
    register: delete_tier1

  - name: ensure folders are deleted
    assert:
      that:
        - delete_tier3.changed
        - delete_tier2.changed
        - delete_tier1.changed
